<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивный график</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h1>Интерактивный график</h1>

<canvas id="myChart" width="100%" height="20%"></canvas>
<table id="threadGroupTable">
    <thead>
    <tr>
        <th>Name</th>
        <th>Jmx Module</th>
        <th>Thread count</th>
        <th>RampUp</th>
        <th>Delay</th>
        <th>Duration</th>
    </tr>
    </thead>
    <tbody>
    <!-- Начальная строка с данными -->
    <tr>
        <td><input type="text" value="jp @ gc - Ultimate Thread Group"></td>
        <td>
            <select>
                <option value="Module1">Module1</option>
                <option value="Module2">Module2</option>
                <option value="Module3">Module3</option>
                <option value="Module4">Module4</option>
                <option value="Module5">Module5</option>
            </select>
        </td>
        <td>
            <input class="threads" type="number" value="10" min="0">
            <select>
                <option value="continue">Continue</option>
                <option value="startNextLoop">Start Next Thread Loop</option>
                <option value="stopThread">Stop Thread</option>
                <option value="stopTest">Stop Test</option>
                <option value="stopTestNow">Stop Test Now</option>
            </select>
        </td>
        <td><input class="rampup" type="number" value="10"></td>
        <td><input class="delay" type="number" value="10"></td>
        <td><input class="duration" type="number" value="10"></td>
    </tr>
    </tbody>
</table>

<button id="add_btn" onclick="add_row()">Add new thread group</button>
<button id="del_btn" onclick="delete_row()">Delete thread group</button>
<form id="chartForm">
    <button type="button" onclick="updateChartData()">Обновить график</button>
</form>

<script>
    var chartData = {
        labels: [],
        datasets: []
    };
    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    scaleLabel: {
                        display: true,
                        labelString: 'Duration'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Thread count'
                    }
                }
            }
        }
    });

    function randomColor() {
        var r = Math.floor(Math.random() * 256);
        var g = Math.floor(Math.random() * 256);
        var b = Math.floor(Math.random() * 256);
        return 'rgba(' + r + ',' + g + ',' + b + ', 1)';
    }

    // Функция для обновления данных графика
    function updateChartData() {
        chartData.labels = [];
        chartData.datasets = [];

        var rows = document.getElementById('threadGroupTable').querySelectorAll('tbody tr');

        rows.forEach(function (row) {
            var name = row.cells[0].querySelector('input').value;
            var threadCount = parseInt(row.cells[2].querySelector('input.threads').value);
            var rampUp = parseInt(row.cells[3].querySelector('input.rampup').value);
            var duration = parseInt(row.cells[5].querySelector('input.duration').value);

            var borderColor = randomColor();

            var dataValues = [];
            for (var t = 0; t <= duration; t++) {
                var currentThreadCount = Math.min(threadCount, (t / rampUp) * threadCount);
                dataValues.push({ x: t, y: currentThreadCount });
            }

            dataValues.push({ x: duration, y: 0 });

            chartData.datasets.push({
                label: name,
                data: dataValues,
                fill: false,
                borderColor: borderColor,
                borderWidth: 1
            });
        });

        myChart.update();
    }

    function add_row() {
        console.log('add_row!')
        const table = document.getElementById('threadGroupTable');
        const row = table.insertRow();
        row.insertCell().innerHTML = '<input type="text" value="New Thread Group">';
        row.insertCell().innerHTML = `<select>
                                        <option value="Module1">Module1</option>
                                        <option value="Module2">Module2</option>
                                        <option value="Module3">Module3</option>
                                        <option value="Module4">Module4</option>
                                        <option value="Module5">Module5</option>
                                      </select>`;
        row.insertCell().innerHTML = `
                <input class="threads" type="number" value="0" min="0">
                <select>
                    <option value="continue">Continue</option>
                    <option value="startNextLoop">Start Next Thread Loop</option>
                    <option value="stopThread">Stop Thread</option>
                    <option value="stopTest">Stop Test</option>
                    <option value="stopTestNow">Stop Test Now</option>
                </select>
            `;
        row.insertCell().innerHTML = `<input class="rampup" type="number" value="10">`;
        row.insertCell().innerHTML = `<input class="delay" type="number" value="10">`;
        row.insertCell().innerHTML = `<input class="duration" type="number" value="10">`;

        updateChartData();
    }

    function delete_row() {
        const table = document.getElementById('threadGroupTable');
        const row = table.querySelector('tbody tr:last-child');
        if (row) row.remove();

        updateChartData();
    }
</script>
<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td, input, select {
        padding: 8px 16px;
        border: 1px solid #ddd;
    }
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    tr:hover {
        background-color: #ddd;
    }
</style>
</body>
</html>
